<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>LinguaFill - Modern English Learning</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react/dist/umd/lucide-react.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Custom Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { BookOpen, Upload, User, Check, X, ArrowRight, Play, Trash2, Plus, Cloud, RefreshCw, Layers } = lucideReact;

        const API_BASE = "https://vocab-backend-lbum.onrender.com";

        // --- Logic Helpers ---
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function speakWord(word) {
            if (!("speechSynthesis" in window)) return;
            const utter = new SpeechSynthesisUtterance(word);
            utter.lang = "en-US";
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        }

        function parseManualText(raw) {
            return raw.split(/\n/).map(line => line.trim()).filter(Boolean).map((line, index) => {
                const parts = line.split(/\t/);
                return {
                    id: `manual-${Date.now()}-${index}`,
                    sentence: parts[0] ? String(parts[0]).trim() : "",
                    word: parts[1] ? String(parts[1]).trim() : "",
                    translation: parts[2] ? String(parts[2]).trim() : "",
                };
            }).filter(c => c.sentence && c.word);
        }

        // --- Main Component ---
        function App() {
            // --- State ---
            const [activeTab, setActiveTab] = useState('folders'); 
            const [decks, setDecks] = useState(() => {
                try {
                    const saved = window.localStorage.getItem("vq_decks_v2");
                    return saved ? JSON.parse(saved) : [{ id: "deck-1", name: "General Practice", cards: [] }];
                } catch { return [{ id: "deck-1", name: "General Practice", cards: [] }]; }
            });
            
            const [activeDeckId, setActiveDeckId] = useState(decks[0]?.id || "deck-1");
            
            // Game State
            const [practiceIndex, setPracticeIndex] = useState(0);
            const [options, setOptions] = useState([]);
            const [selectedOptionId, setSelectedOptionId] = useState(null);
            const [feedback, setFeedback] = useState(""); // 'correct', 'wrong', or ''
            const [revealed, setRevealed] = useState(false);

            // Import State
            const [manualText, setManualText] = useState("");

            // Cloud State
            const [syncId, setSyncId] = useState("");
            const [cloudStatus, setCloudStatus] = useState("");

            // --- Derived State ---
            const activeDeck = decks.find(d => d.id === activeDeckId) || decks[0];
            const cards = activeDeck ? activeDeck.cards : [];
            const currentCard = cards.length > 0 ? cards[practiceIndex] : null;

            // --- Effects ---
            useEffect(() => {
                window.localStorage.setItem("vq_decks_v2", JSON.stringify(decks));
            }, [decks]);

            // Setup Quiz Options
            useEffect(() => {
                if (!currentCard) { setOptions([]); return; }
                
                // Find distractors
                const others = cards.filter((c, idx) => idx !== practiceIndex);
                // If not enough cards in this deck, grab random words from other decks for distractors? 
                // For now keep logic simple: if not enough cards, just use what we have
                const distractors = shuffleArray(others).slice(0, Math.min(3, others.length));
                
                const combined = shuffleArray([currentCard, ...distractors]);
                setOptions(combined);
                setSelectedOptionId(null);
                setFeedback("");
                setRevealed(false);
            }, [currentCard, practiceIndex, cards.length]); // Added dependencies to refresh when content changes

            // --- Handlers ---
            
            const handleNext = () => {
                if(cards.length === 0) return;
                setPracticeIndex((prev) => (prev + 1) % cards.length);
            };

            const handleChooseOption = (optionId) => {
                if (revealed) return; // Prevent double guessing
                const chosen = options.find(o => o.id === optionId);
                setSelectedOptionId(optionId);
                setRevealed(true);
                
                if (chosen.word.toLowerCase() === currentCard.word.toLowerCase()) {
                    setFeedback("correct");
                    speakWord(chosen.word);
                    // Auto advance after 1.5s
                    setTimeout(handleNext, 1500);
                } else {
                    setFeedback("wrong");
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                    
                    const newCards = rows.filter(r => r[0] && r[1]).map((row, i) => ({
                        id: `excel-${Date.now()}-${i}`,
                        sentence: String(row[0]).trim(),
                        word: String(row[1]).trim(),
                        translation: row[2] ? String(row[2]).trim() : ""
                    }));

                    if (newCards.length) {
                        setDecks(prev => prev.map(d => d.id === activeDeckId ? { ...d, cards: [...d.cards, ...newCards] } : d));
                        alert(`Added ${newCards.length} sentences to "${activeDeck.name}"`);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleManualImport = () => {
                const newCards = parseManualText(manualText);
                if (newCards.length) {
                    setDecks(prev => prev.map(d => d.id === activeDeckId ? { ...d, cards: [...d.cards, ...newCards] } : d));
                    setManualText("");
                    alert(`Added ${newCards.length} sentences to "${activeDeck.name}"`);
                }
            };

            const createDeck = () => {
                const name = prompt("Enter new folder name:");
                if(name) {
                    const newDeck = { id: `deck-${Date.now()}`, name, cards: [] };
                    setDecks([...decks, newDeck]);
                    setActiveDeckId(newDeck.id);
                }
            };

            const deleteDeck = (id) => {
                if(decks.length <= 1) return alert("Keep at least one folder.");
                if(confirm("Delete this folder?")) {
                    setDecks(decks.filter(d => d.id !== id));
                    if(activeDeckId === id) setActiveDeckId(decks.find(d => d.id !== id).id);
                }
            };

            const handleCloudAction = async (action) => {
                if(!syncId) return alert("Enter a Sync ID");
                setCloudStatus("Processing...");
                try {
                    const url = `${API_BASE}/decks/${encodeURIComponent(syncId)}`;
                    const res = await fetch(url, {
                        method: action === 'save' ? 'PUT' : 'GET',
                        headers: { "Content-Type": "application/json" },
                        body: action === 'save' ? JSON.stringify({ decks }) : undefined
                    });
                    if(!res.ok) throw new Error("Failed");
                    
                    if(action === 'load') {
                        const data = await res.json();
                        setDecks(data.decks || []);
                    }
                    setCloudStatus(action === 'save' ? "Saved successfully!" : "Loaded successfully!");
                } catch(e) {
                    setCloudStatus("Error occurred.");
                    console.error(e);
                }
            };

            // --- UI Components ---
            
            return (
                <div className="min-h-screen bg-gray-50 text-slate-800 pb-12">
                    
                    {/* Navigation */}
                    <nav className="bg-white shadow-sm sticky top-0 z-20 border-b border-gray-100">
                        <div className="max-w-4xl mx-auto px-4">
                            <div className="flex justify-between h-16">
                                <div className="flex items-center gap-2">
                                    <div className="bg-indigo-600 text-white p-1.5 rounded-lg">
                                        <Layers size={20} />
                                    </div>
                                    <span className="text-xl font-bold text-gray-800 tracking-tight">LinguaFill</span>
                                </div>
                                <div className="flex space-x-1 items-center">
                                    <NavButton active={activeTab === 'folders'} onClick={() => setActiveTab('folders')} icon={<BookOpen size={18} />} label="Library" />
                                    <NavButton active={activeTab === 'import'} onClick={() => setActiveTab('import')} icon={<Upload size={18} />} label="Import" />
                                    <NavButton active={activeTab === 'user'} onClick={() => setActiveTab('user')} icon={<User size={18} />} label="Profile" />
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-3xl mx-auto px-4 py-8">
                        
                        {/* --- TAB: LIBRARY & GAME --- */}
                        {activeTab === 'folders' && (
                            <div className="animate-fade-in grid grid-cols-1 md:grid-cols-12 gap-6">
                                
                                {/* Sidebar: Folder Selection */}
                                <div className="md:col-span-4 space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wide">My Collections</h3>
                                        <button onClick={createDeck} className="text-indigo-600 hover:bg-indigo-50 p-1 rounded transition"><Plus size={18}/></button>
                                    </div>
                                    <div className="space-y-2">
                                        {decks.map(deck => (
                                            <div 
                                                key={deck.id}
                                                onClick={() => { setActiveDeckId(deck.id); setPracticeIndex(0); }}
                                                className={`p-3 rounded-lg cursor-pointer flex justify-between items-center transition ${activeDeckId === deck.id ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-600 hover:bg-gray-100 border border-gray-200'}`}
                                            >
                                                <div className="flex items-center gap-3 overflow-hidden">
                                                    <BookOpen size={16} className={activeDeckId === deck.id ? "opacity-80" : "text-gray-400"} />
                                                    <span className="truncate font-medium text-sm">{deck.name}</span>
                                                </div>
                                                <span className={`text-xs px-2 py-0.5 rounded-full ${activeDeckId === deck.id ? 'bg-white/20' : 'bg-gray-100'}`}>
                                                    {deck.cards.length}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                    {activeDeck && (
                                        <button onClick={() => deleteDeck(activeDeck.id)} className="w-full mt-4 flex items-center justify-center gap-2 text-xs text-red-500 hover:text-red-700 py-2">
                                            <Trash2 size={14} /> Delete Selected Folder
                                        </button>
                                    )}
                                </div>

                                {/* Main: The Game Area */}
                                <div className="md:col-span-8">
                                    {!currentCard ? (
                                        <div className="bg-white rounded-2xl p-12 text-center border-2 border-dashed border-gray-200">
                                            <div className="inline-flex items-center justify-center w-16 h-16 bg-gray-50 rounded-full mb-4 text-gray-300">
                                                <Layers size={32} />
                                            </div>
                                            <h3 className="text-lg font-bold text-gray-700">This folder is empty</h3>
                                            <p className="text-gray-500 mb-6 text-sm">Switch to the "Import" tab to add content here.</p>
                                            <button onClick={() => setActiveTab('import')} className="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-medium text-sm hover:bg-indigo-700 transition">
                                                Go to Import
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="bg-white rounded-2xl shadow-xl shadow-indigo-100/50 border border-gray-100 overflow-hidden relative">
                                            {/* Header */}
                                            <div className="bg-gray-50 px-6 py-4 flex justify-between items-center border-b border-gray-100">
                                                <span className="text-xs font-bold text-indigo-500 uppercase tracking-wider">{activeDeck.name}</span>
                                                <span className="text-xs text-gray-400 font-medium">{practiceIndex + 1} / {cards.length}</span>
                                            </div>
                                            
                                            <div className="p-8">
                                                {/* Sentence */}
                                                <div className="text-2xl text-center leading-relaxed text-slate-800 font-medium mb-10">
                                                    {currentCard.sentence.split('____').map((part, i, arr) => (
                                                        <React.Fragment key={i}>
                                                            {part}
                                                            {i < arr.length - 1 && (
                                                                <span className={`inline-block min-w-[80px] text-center border-b-2 mx-1 transition-colors duration-300 font-bold
                                                                    ${revealed && feedback === 'correct' ? 'border-green-500 text-green-600' : 
                                                                      revealed && feedback === 'wrong' ? 'border-red-400 text-red-500' : 
                                                                      'border-indigo-300 text-transparent'}`}>
                                                                    {revealed ? currentCard.word : "?"}
                                                                </span>
                                                            )}
                                                        </React.Fragment>
                                                    ))}
                                                </div>

                                                {/* Options */}
                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-md mx-auto">
                                                    {options.map(opt => {
                                                        const isSelected = selectedOptionId === opt.id;
                                                        const isCorrect = opt.word.toLowerCase() === currentCard.word.toLowerCase();
                                                        
                                                        let btnClass = "py-3.5 px-4 rounded-xl border text-sm font-medium transition-all duration-200 flex justify-between items-center ";
                                                        
                                                        if (revealed) {
                                                            if (isCorrect) btnClass += "bg-green-50 border-green-500 text-green-700 ";
                                                            else if (isSelected && !isCorrect) btnClass += "bg-red-50 border-red-500 text-red-700 shake ";
                                                            else btnClass += "opacity-50 border-gray-100 bg-gray-50 ";
                                                        } else {
                                                            btnClass += "bg-white border-gray-200 text-gray-600 hover:border-indigo-400 hover:text-indigo-600 hover:shadow-sm";
                                                        }

                                                        return (
                                                            <button 
                                                                key={opt.id} 
                                                                onClick={() => handleChooseOption(opt.id)}
                                                                className={btnClass}
                                                                disabled={revealed}
                                                            >
                                                                <span>{opt.word}</span>
                                                                {revealed && isCorrect && <Check size={16} />}
                                                                {revealed && isSelected && !isCorrect && <X size={16} />}
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>

                                            {/* Footer / Feedback */}
                                            <div className="h-16 bg-gray-50 border-t border-gray-100 flex items-center justify-between px-6">
                                                <div className="flex items-center gap-3">
                                                    {revealed && currentCard.translation && (
                                                        <span className="text-sm text-gray-500 flex items-center gap-2 animate-fade-in">
                                                            <span className="w-1 h-1 bg-gray-400 rounded-full"></span>
                                                            Translation: <span className="font-semibold text-gray-700">{currentCard.translation}</span>
                                                        </span>
                                                    )}
                                                </div>
                                                <div className="flex gap-2">
                                                     <button onClick={() => speakWord(currentCard.word)} className="p-2 text-gray-400 hover:text-indigo-600 hover:bg-white rounded-full transition">
                                                        <Play size={18} />
                                                    </button>
                                                    <button onClick={handleNext} className="text-sm font-bold text-indigo-600 hover:text-indigo-800 px-3 py-1 rounded hover:bg-indigo-50 transition">
                                                        Skip / Next
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* --- TAB: IMPORT --- */}
                        {activeTab === 'import' && (
                            <div className="animate-fade-in max-w-2xl mx-auto space-y-6">
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <div className="flex items-center gap-3 mb-4">
                                        <div className="bg-indigo-100 p-2 rounded-lg text-indigo-600"><Upload size={20} /></div>
                                        <div>
                                            <h2 className="text-lg font-bold text-gray-800">Add to: {activeDeck.name}</h2>
                                            <p className="text-xs text-gray-500">Upload Excel or paste text</p>
                                        </div>
                                    </div>

                                    {/* File Input */}
                                    <label className="block w-full border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 hover:border-indigo-400 transition cursor-pointer mb-6 group">
                                        <input type="file" accept=".xlsx,.xls,.csv" onChange={handleFileUpload} className="hidden" />
                                        <p className="text-sm text-gray-600 font-medium group-hover:text-indigo-600">Click to upload Excel / CSV</p>
                                        <p className="text-xs text-gray-400 mt-1">Format: Column A (Sentence with ____), B (Word), C (Translation)</p>
                                    </label>

                                    <div className="relative">
                                        <div className="absolute top-3 right-3 text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">Manual Paste</div>
                                        <textarea 
                                            value={manualText}
                                            onChange={(e) => setManualText(e.target.value)}
                                            className="w-full h-40 p-4 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none resize-none bg-gray-50 font-mono"
                                            placeholder={`I bought a new ____.\tcar\tmachonit\nShe is very ____.\thappy\tsmecha`}
                                        ></textarea>
                                    </div>

                                    <div className="mt-4 flex justify-end">
                                        <button 
                                            onClick={handleManualImport}
                                            disabled={!manualText.trim()}
                                            className="bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700 transition flex items-center gap-2"
                                        >
                                            Process Text <ArrowRight size={18} />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- TAB: USER & SYNC --- */}
                        {activeTab === 'user' && (
                            <div className="animate-fade-in max-w-2xl mx-auto space-y-6">
                                {/* Profile Card */}
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center gap-5">
                                    <div className="h-16 w-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xl font-bold shadow-lg">
                                        ME
                                    </div>
                                    <div>
                                        <h2 className="text-xl font-bold text-gray-800">My Profile</h2>
                                        <p className="text-gray-500 text-sm">Total Collections: {decks.length}</p>
                                    </div>
                                </div>

                                {/* Sync Card */}
                                <div className="bg-indigo-900 text-white p-6 rounded-xl shadow-lg relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-8 opacity-10 transform translate-x-4 -translate-y-4">
                                        <Cloud size={100} />
                                    </div>
                                    
                                    <div className="relative z-10">
                                        <h3 className="font-bold text-lg mb-2 flex items-center gap-2"><RefreshCw size={18}/> Cloud Sync</h3>
                                        <p className="text-indigo-200 text-sm mb-4 max-w-sm">
                                            Enter a unique ID to sync your progress across devices.
                                        </p>
                                        
                                        <div className="flex gap-2 max-w-md">
                                            <input 
                                                type="text" 
                                                value={syncId} 
                                                onChange={(e) => setSyncId(e.target.value)}
                                                placeholder="e.g. john-english-123"
                                                className="flex-1 bg-indigo-800/50 border border-indigo-700 rounded-lg px-4 py-2 text-sm text-white placeholder-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400" 
                                            />
                                        </div>
                                        
                                        <div className="flex gap-3 mt-4">
                                            <button onClick={() => handleCloudAction('save')} className="bg-white text-indigo-900 px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-50 transition">
                                                Save to Cloud
                                            </button>
                                            <button onClick={() => handleCloudAction('load')} className="bg-indigo-700 text-white border border-indigo-600 px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-600 transition">
                                                Load Data
                                            </button>
                                        </div>

                                        {cloudStatus && (
                                            <div className="mt-3 text-xs font-mono text-indigo-300">
                                                Status: {cloudStatus}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Stats Grid */}
                                <div className="grid grid-cols-3 gap-4">
                                    <div className="bg-white p-4 rounded-xl border border-gray-200 text-center">
                                        <div className="text-2xl font-bold text-gray-800">{decks.reduce((acc, d) => acc + d.cards.length, 0)}</div>
                                        <div className="text-xs text-gray-400 uppercase tracking-wide mt-1">Total Words</div>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl border border-gray-200 text-center">
                                        <div className="text-2xl font-bold text-gray-800">{decks.length}</div>
                                        <div className="text-xs text-gray-400 uppercase tracking-wide mt-1">Decks</div>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl border border-gray-200 text-center">
                                        <div className="text-2xl font-bold text-emerald-500">Active</div>
                                        <div className="text-xs text-gray-400 uppercase tracking-wide mt-1">Status</div>
                                    </div>
                                </div>
                            </div>
                        )}

                    </main>
                </div>
            );
        }

        function NavButton({ active, onClick, icon, label }) {
            return (
                <button 
                    onClick={onClick}
                    className={`flex items-center space-x-2 px-3 py-2 rounded-lg transition-all duration-200 ${
                        active 
                        ? 'bg-indigo-50 text-indigo-700 font-semibold' 
                        : 'text-gray-500 hover:bg-gray-100 hover:text-gray-900'
                    }`}
                >
                    {icon}
                    <span className="hidden sm:inline text-sm">{label}</span>
                </button>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
